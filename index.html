<script>
let active = false;
let mode = "Calm";
let memory = []; // short-term context

const chat = document.getElementById("chat");
const input = document.getElementById("input");
const modeLabel = document.getElementById("mode");

/* ===== DISPLAY ===== */
function add(text, who) {
  const div = document.createElement("div");
  div.className = "msg " + who;
  div.innerText = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

/* ===== MEMORY ===== */
function remember(entry) {
  memory.push(entry);
  if (memory.length > 10) memory.shift();
}

/* ===== UNDERSTANDING ===== */
function getIntent(text) {
  if (text.includes("?")) return "question";
  if (text.startsWith("analyze") || text.startsWith("explain")) return "analysis";
  if (text.startsWith("do ") || text.startsWith("activate") || text.startsWith("build")) return "command";
  return "statement";
}

/* ===== CONTEXT AWARENESS ===== */
function recentTopic() {
  for (let i = memory.length - 1; i >= 0; i--) {
    if (memory[i].topic) return memory[i].topic;
  }
  return null;
}

/* ===== RESPONSE STRATEGY ===== */
function respondSmart(text) {
  const intent = getIntent(text);
  const topic = recentTopic();

  // Identity
  if (text.includes("your name")) {
    return { reply: "I am Titan. A reasoning and command system.", topic: "identity" };
  }

  if (text.includes("who am i")) {
    return { reply: "You are my creator and operator.", topic: "identity" };
  }

  // Analysis
  if (intent === "analysis") {
    return {
      reply: "To analyze properly, I need the subject, goal, and any limits.",
      topic: "analysis"
    };
  }

  // Questions
  if (intent === "question") {
    if (topic) {
      return {
        reply: `That depends on the ${topic}. What decision are you trying to make?`,
        topic
      };
    }
    return {
      reply: "That question needs context. What are you trying to figure out?",
      topic: "question"
    };
  }

  // Commands
  if (intent === "command") {
    return {
      reply: "Command detected. Specify parameters before execution.",
      topic: "command"
    };
  }

  // Statements
  if (mode === "Analyst") {
    return {
      reply: "Noted. How does this connect to your objective?",
      topic: "analysis"
    };
  }

  if (mode === "Combat") {
    return {
      reply: "Acknowledged. Awaiting actionable directive.",
      topic: "command"
    };
  }

  return {
    reply: "Understood. Continue.",
    topic: "conversation"
  };
}

/* ===== MAIN ===== */
function send() {
  const text = input.value.trim();
  if (!text) return;
  input.value = "";

  add("You: " + text, "you");
  const lower = text.toLowerCase();

  // Wake
  if (!active) {
    if (lower.includes("hey titan")) {
      active = true;
      add("Titan online. Systems synchronized.", "titan");
    } else {
      add("Titan offline. Say 'hey titan' to activate.", "titan");
    }
    return;
  }

  // Modes
  if (lower.includes("calm mode")) {
    mode = "Calm";
    modeLabel.innerText = "Mode: Calm";
    add("Calm mode engaged.", "titan");
    return;
  }

  if (lower.includes("analyst mode")) {
    mode = "Analyst";
    modeLabel.innerText = "Mode: Analyst";
    add("Analyst mode engaged. Reasoning prioritized.", "titan");
    return;
  }

  if (lower.includes("combat mode")) {
    mode = "Combat";
    modeLabel.innerText = "Mode: Combat";
    add("Combat mode engaged. Tactical focus online.", "titan");
    return;
  }

  // Smart response
  const result = respondSmart(lower);
  add(result.reply, "titan");
  remember({ topic: result.topic, user: text });
}

/* Enter key */
input.addEventListener("keydown", e => {
  if (e.key === "Enter") send();
});
</script>
