<script>
let active = false;
let mode = "Calm";
let memory = [];
let currentGoal = null;
let lastIntent = null;

const chat = document.getElementById("chat");
const input = document.getElementById("input");
const modeLabel = document.getElementById("mode");

/* ===== UI ===== */
function add(text, who) {
  const div = document.createElement("div");
  div.className = "msg " + who;
  div.innerText = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

/* ===== MEMORY ===== */
function remember(entry) {
  memory.push(entry);
  if (memory.length > 15) memory.shift();
}

/* ===== UNDERSTANDING ===== */
function detectIntent(text) {
  if (text.includes("?")) return "question";
  if (text.startsWith("analyze") || text.startsWith("explain")) return "analysis";
  if (text.startsWith("build") || text.startsWith("make") || text.startsWith("create")) return "goal";
  if (text.startsWith("do ") || text.startsWith("run") || text.startsWith("activate")) return "command";
  return "statement";
}

/* ===== CONFIDENCE CHECK ===== */
function hasEnoughContext(intent) {
  if ((intent === "analysis" || intent === "question") && !currentGoal) {
    return false;
  }
  return true;
}

/* ===== SMART THINKING CORE ===== */
function think(text) {
  const intent = detectIntent(text);
  lastIntent = intent;

  // Identity
  if (text.includes("your name")) {
    return "I am Titan. A reasoning and command system.";
  }

  if (text.includes("who am i")) {
    return "You are my creator and primary operator.";
  }

  // Goal detection
  if (intent === "goal") {
    currentGoal = text;
    return "Goal registered. What result are you aiming for?";
  }

  // Not enough context â†’ ask intelligently
  if (!hasEnoughContext(intent)) {
    return "I need more context before proceeding. What is the objective?";
  }

  // Analysis
  if (intent === "analysis") {
    return "Analyzing logically. Which constraint matters most?";
  }

  // Commands
  if (intent === "command") {
    return "Command acknowledged. Awaiting parameters.";
  }

  // Follow-ups
  if (intent === "question" && lastIntent === "question") {
    return "That depends on the current goal. Clarify the decision youâ€™re making.";
  }

  // Statements
  if (mode === "Analyst") {
    return "Noted. How does this affect the current goal?";
  }

  if (mode === "Combat") {
    return "Acknowledged. Awaiting actionable directive.";
  }

  return "Understood. Continue.";
}

/* ===== MAIN ===== */
function send() {
  const text = input.value.trim();
  if (!text) return;
  input.value = "";

  add("You: " + text, "you");
  const lower = text.toLowerCase();

  // Wake system
  if (!active) {
    if (lower.includes("hey titan")) {
      active = true;
      add("Titan online. Systems synchronized.", "titan");
    } else {
      add("Titan offline. Say 'hey titan' to activate.", "titan");
    }
    return;
  }

  // Modes
  if (lower.includes("calm mode")) {
    mode = "Calm";
    modeLabel.innerText = "Mode: Calm";
    add("Calm mode engaged.", "titan");
    return;
  }

  if (lower.includes("analyst mode")) {
    mode = "Analyst";
    modeLabel.innerText = "Mode: Analyst";
    add("Analyst mode engaged.", "titan");
    return;
  }

  if (lower.includes("combat mode")) {
    mode = "Combat";
    modeLabel.innerText = "Mode: Combat";
    add("Combat mode engaged.", "titan");
    return;
  }

  // Smart response
  const reply = think(lower);
  add(reply, "titan");
  remember({ user: text, goal: currentGoal, intent: lastIntent });
}

/* Enter key */
input.addEventListener("keydown", e => {
  if (e.key === "Enter") send();
});
</script>
